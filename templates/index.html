<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Answer Sheet Extraction</title>
    <style>
        /* Your existing CSS for the new design goes here */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            max-width: 1200px;
            width: 100%;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .header {
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: pulse 4s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            position: relative;
            z-index: 1;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }

        .steps {
            display: flex;
            justify-content: center;
            padding: 20px 30px;
            background: rgba(79, 70, 229, 0.05);
            border-bottom: 1px solid rgba(79, 70, 229, 0.1);
        }

        .step {
            display: flex;
            align-items: center;
            margin: 0 20px;
            padding: 10px 20px;
            border-radius: 25px;
            background: white;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .step.active {
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(79, 70, 229, 0.3);
        }

        .step.completed {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .step-number {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: rgba(79, 70, 229, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .step.active .step-number,
        .step.completed .step-number {
            background: rgba(255, 255, 255, 0.2);
        }

        .content {
            padding: 40px;
            min-height: 500px;
        }

        .step-content {
            display: none;
            animation: fadeIn 0.5s ease-in-out;
        }

        .step-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .upload-area {
            border: 3px dashed #4f46e5;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            margin: 20px 0;
            background: linear-gradient(135deg, rgba(79, 70, 229, 0.02), rgba(124, 58, 237, 0.02));
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .upload-area:hover {
            border-color: #7c3aed;
            background: linear-gradient(135deg, rgba(79, 70, 229, 0.05), rgba(124, 58, 237, 0.05));
            transform: translateY(-2px);
        }

        .upload-area.dragover {
            border-color: #10b981;
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(5, 150, 105, 0.1));
        }

        .upload-icon {
            font-size: 3rem;
            color: #4f46e5;
            margin-bottom: 20px;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }

        .file-input {
            display: none;
        }

        .btn {
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(79, 70, 229, 0.3);
            margin: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(79, 70, 229, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled { /* Added disabled state for buttons */
            background: #cccccc;
            box-shadow: none;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6b7280, #4b5563);
            box-shadow: 0 4px 15px rgba(107, 114, 128, 0.3);
        }

        .btn-secondary:hover {
            box-shadow: 0 6px 20px rgba(107, 114, 128, 0.4);
        }

        .file-list {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .file-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #e5e7eb;
            transition: all 0.3s ease;
        }

        .file-item:hover {
            background: rgba(79, 70, 229, 0.05);
        }

        .file-item:last-child {
            border-bottom: none;
        }

        .file-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #ef4444, #dc2626);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            margin-right: 15px;
        }

        .file-info {
            flex: 1;
        }

        .file-name {
            font-weight: 600;
            color: #1f2937;
        }

        .file-size {
            font-size: 0.9rem;
            color: #6b7280;
        }

        .select-group {
            margin: 20px 0;
        }

        .select-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #1f2937;
        }

        .custom-select {
            width: 100%;
            padding: 12px 20px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 1rem;
            background: white;
            transition: all 0.3s ease;
        }

        .custom-select:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .preview-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 20px;
        }

        .preview-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .preview-section:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }

        .preview-section h3 {
            margin-bottom: 20px;
            color: #1f2937;
            font-size: 1.3rem;
            padding-bottom: 10px;
            border-bottom: 2px solid #e5e7eb;
        }

        .pdf-preview {
            width: 100%;
            height: 400px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            background: #f9fafb;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6b7280;
            font-size: 1.1rem;
            flex-direction: column; /* To stack buttons and iframe */
        }

        .pdf-preview iframe {
            width: 100%;
            height: calc(100% - 50px); /* Adjust height for buttons */
            border: none;
        }

        .pdf-view-toggle {
            display: flex;
            justify-content: center;
            margin-bottom: 15px;
            gap: 10px;
        }

        .pdf-view-toggle .btn {
            padding: 8px 20px;
            font-size: 0.9rem;
            margin: 0;
            border-radius: 20px;
            background: #e5e7eb;
            color: #4f46e5;
            box-shadow: none;
        }

        .pdf-view-toggle .btn.active {
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            color: white;
            box-shadow: 0 4px 10px rgba(79, 70, 229, 0.2);
        }

        .pdf-view-toggle .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 5px rgba(79, 70, 229, 0.1);
        }

        /* --- START OF NEW CSS FOR GENERATED PDF PREVIEW --- */
        .generated-pdf-preview { /* New container for the generated PDF iframe */
            width: 100%;
            height: 400px; /* Same height as original PDF preview */
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            background: #f9fafb;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6b7280;
            font-size: 1.1rem;
            flex-direction: column;
            overflow: hidden; /* Ensure content stays within borders */
        }

        .generated-pdf-preview iframe {
            width: 100%;
            height: 100%; /* No buttons here, so fill full height */
            border: none;
        }
        /* --- END OF NEW CSS FOR GENERATED PDF PREVIEW --- */


        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%; /* Take full height of parent */
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e5e7eb;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .download-section {
            text-align: center;
            margin-top: 30px;
            padding: 20px;
            background: rgba(79, 70, 229, 0.05);
            border-radius: 15px;
        }

        @media (max-width: 768px) {
            .steps {
                flex-direction: column;
                gap: 10px;
            }

            .step {
                margin: 5px 0;
            }

            .preview-container {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Answer Sheet Extraction</h1>
            <p>Advanced AI-powered text extraction from answer sheets</p>
        </div>

        <div class="steps">
            <div class="step active" data-step="1">
                <div class="step-number">1</div>
                <span>Upload Files</span>
            </div>
            <div class="step" data-step="2">
                <div class="step-number">2</div>
                <span>Select & Configure</span>
            </div>
            <div class="step" data-step="3">
                <div class="step-number">3</div>
                <span>Extract & Download</span>
            </div>
        </div>

        <div class="content">
            <div class="step-content active" data-step="1">
                <h2>Step 1: Upload Your Files</h2>

                <div class="upload-area" id="folderUpload">
                    <div class="upload-icon">üìÅ</div>
                    <h3>Upload Answer Sheet Folder</h3>
                    <p>Drag and drop a folder containing PDF files, or click to browse</p>
                    <input type="file" id="folderInput" class="file-input" webkitdirectory directory multiple accept=".pdf">
                    <button class="btn" onclick="document.getElementById('folderInput').click()">
                        Choose Folder
                    </button>
                </div>

                <div class="upload-area" id="questionUpload">
                    <div class="upload-icon">üìÑ</div>
                    <h3>Upload Question Paper</h3>
                    <p>Upload the question paper PDF for reference</p>
                    <input type="file" id="questionInput" class="file-input" accept=".pdf">
                    <button class="btn" onclick="document.getElementById('questionInput').click()">
                        Choose Question Paper
                    </button>
                </div>

                <div id="fileList" class="file-list" style="display: none;">
                    <h3>Uploaded Files</h3>
                    <div id="fileItems"></div>
                </div>

                <div style="text-align: center; margin-top: 30px;">
                    <button class="btn" onclick="nextStep()" id="step1Next" disabled>
                        Next Step ‚Üí
                    </button>
                </div>
            </div>

            <div class="step-content" data-step="2">
                <h2>Step 2: Select Files and Model</h2>

                <div class="select-group">
                    <label for="fileSelection">Choose files to process:</label>
                    <select id="fileSelection" class="custom-select">
                        <option value="">Select files...</option>
                        <option value="all">Process all PDFs in folder</option>
                    </select>
                </div>

                <div class="select-group">
                    <label for="modelSelection">Select ML Model:</label>
                    <select id="modelSelection" class="custom-select">
                        <option value="">Choose a model...</option>
                        <option value="openai">OpenAI GPT-4 Vision - Advanced AI text extraction</option>
                        </select>
                </div>

                <div style="text-align: center; margin-top: 30px;">
                    <button class="btn btn-secondary" onclick="prevStep()">
                        ‚Üê Previous
                    </button>
                    <button class="btn" onclick="nextStep()" id="step2Next" disabled>
                        Process Files ‚Üí
                    </button>
                </div>
            </div>

            <div class="step-content" data-step="3">
                <h2>Step 3: Preview and Download Results</h2>

                <div class="preview-container">
                    <div class="preview-section">
                        <h3>üìÑ Original PDF Preview</h3> <div class="pdf-preview" id="pdfPreviewContainer">
                            <div class="pdf-view-toggle">
                                <button class="btn active" id="viewOriginalPdfBtn" disabled>Original</button>
                                <button class="btn" id="viewGeneratedPdfBtn" disabled>Generated</button>
                            </div>
                            <iframe id="pdfPreviewIframe" src="" type="application/pdf" style="display: none;"></iframe>
                            <p id="pdfPreviewMessage">Select files to process...</p>
                        </div>
                    </div>

                    <div class="preview-section">
                        <h3>ü§ñ Generated PDF Output</h3>
                        <div class="generated-pdf-preview" id="generatedPdfPreviewContainer">
                            <iframe id="generatedPdfPreviewIframe" src="" type="application/pdf" style="display: none;"></iframe>
                            <p id="generatedPdfPreviewMessage">Generated PDF will appear here.</p>
                        </div>
                        </div>
                </div>

                <div class="download-section">
                    <h3>üì• Download Results</h3>
                    <p id="downloadMessage">Your generated PDF will be ready for download after processing.</p>
                    <button class="btn" onclick="downloadPdf()" id="downloadBtn" disabled>
                        Download as PDF
                    </button>
                </div>

                <div style="text-align: center; margin-top: 30px;">
                    <button class="btn btn-secondary" onclick="prevStep()">
                        ‚Üê Previous
                    </button>
                    <button class="btn" onclick="startOver()">
                        Start Over
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentStep = 1;
        let uploadedFiles = []; // Student answer sheets (File objects with webkitRelativePath)
        let questionPaper = null; // Question paper (File object)
        let selectedFiles = []; // Files chosen for processing in Step 2 (File objects)
        let selectedModel = '';

        // Variables to store paths for PDF previews
        let originalStudentPdfPath = null; // Path to original student PDF (from Flask /preview/ route)
        let generatedPdfPath = null; // Path to generated PDF (from Flask /preview/ route)
        let currentPdfView = 'original'; // To manage which PDF is shown in the left iframe


        // Initialize drag and drop functionality
        function initDragDrop() {
            const uploadAreas = document.querySelectorAll('.upload-area');

            uploadAreas.forEach(area => {
                area.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    area.classList.add('dragover');
                });

                area.addEventListener('dragleave', () => {
                    area.classList.remove('dragover');
                });

                area.addEventListener('drop', (e) => {
                    e.preventDefault();
                    area.classList.remove('dragover');

                    const files = Array.from(e.dataTransfer.files);
                    if (area.id === 'folderUpload') {
                        handleFolderUpload(files);
                    } else if (area.id === 'questionUpload') {
                        handleQuestionUpload(files);
                    }
                });
            });
        }

        // Handle folder upload (student answer sheets)
        function handleFolderUpload(files) {
            // Filter only PDF files and store them
            uploadedFiles = files.filter(file => file.type === 'application/pdf');
            displayFiles();
            updateStep1Button();
        }

        // Handle question paper upload
        function handleQuestionUpload(files) {
            const pdfFile = files.find(file => file.type === 'application/pdf');
            if (pdfFile) {
                questionPaper = pdfFile;
                displayFiles(); // Update display to show question paper
                updateStep1Button();
            }
        }

        // File input handlers
        document.getElementById('folderInput').addEventListener('change', (e) => {
            handleFolderUpload(Array.from(e.target.files));
        });

        document.getElementById('questionInput').addEventListener('change', (e) => {
            handleQuestionUpload(Array.from(e.target.files));
        });

        // Display uploaded files
        function displayFiles() {
            const fileList = document.getElementById('fileList');
            const fileItems = document.getElementById('fileItems');

            if (uploadedFiles.length > 0 || questionPaper) {
                fileList.style.display = 'block';
                fileItems.innerHTML = ''; // Clear previous list

                if (questionPaper) {
                    const qItem = document.createElement('div');
                    qItem.className = 'file-item';
                    qItem.innerHTML = `
                        <div class="file-icon" style="background: #3b82f6;">QP</div>
                        <div class="file-info">
                            <div class="file-name">Question Paper: ${questionPaper.name}</div>
                            <div class="file-size">${(questionPaper.size / (1024 * 1024)).toFixed(2)} MB</div>
                        </div>
                    `;
                    fileItems.appendChild(qItem);
                }

                uploadedFiles.forEach((file) => {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-item';
                    fileItem.innerHTML = `
                        <div class="file-icon">PDF</div>
                        <div class="file-info">
                            <div class="file-name">${file.webkitRelativePath || file.name}</div>
                            <div class="file-size">${(file.size / (1024 * 1024)).toFixed(2)} MB</div>
                        </div>
                    `;
                    fileItems.appendChild(fileItem);
                });

                updateFileSelection(); // Populate the dropdown in Step 2
            } else {
                fileList.style.display = 'none';
            }
        }

        // Update file selection dropdown for student PDFs in Step 2
        function updateFileSelection() {
            const select = document.getElementById('fileSelection');
            select.innerHTML = '<option value="">Select files...</option>';
            select.innerHTML += '<option value="all">Process all PDFs in folder</option>';

            uploadedFiles.forEach((file, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = file.webkitRelativePath || file.name; // Use relative path for display
                select.appendChild(option);
            });
        }

        // Update step 1 button state
        function updateStep1Button() {
            const nextBtn = document.getElementById('step1Next');
            nextBtn.disabled = !(uploadedFiles.length > 0 && questionPaper);
        }

        // File selection change handler (in Step 2)
        document.getElementById('fileSelection').addEventListener('change', (e) => {
            const value = e.target.value;
            if (value === 'all') {
                selectedFiles = uploadedFiles;
            } else if (value !== '') {
                selectedFiles = [uploadedFiles[parseInt(value)]];
            } else {
                selectedFiles = [];
            }
            updateStep2Button();
        });

        // Model selection change handler (in Step 2)
        document.getElementById('modelSelection').addEventListener('change', (e) => {
            selectedModel = e.target.value;
            updateStep2Button();
        });

        // Update step 2 button state
        function updateStep2Button() {
            const nextBtn = document.getElementById('step2Next');
            nextBtn.disabled = !(selectedFiles.length > 0 && selectedModel);
        }

        // Navigation functions
        function nextStep() {
            if (currentStep < 3) {
                if (currentStep === 2) {
                    processFiles(); // Trigger backend processing when going from Step 2 to 3
                }
                currentStep++;
                updateStepDisplay();
            }
        }

        function prevStep() {
            if (currentStep > 1) {
                currentStep--;
                updateStepDisplay();
            }
        }

        function updateStepDisplay() {
            // Update step indicators
            document.querySelectorAll('.step').forEach((step, index) => {
                step.classList.remove('active', 'completed');
                if (index + 1 === currentStep) {
                    step.classList.add('active');
                } else if (index + 1 < currentStep) {
                    step.classList.add('completed');
                }
                step.onclick = () => { // Allow clicking steps to navigate
                    if (index + 1 <= currentStep) { // Only allow going back or to current step
                        currentStep = index + 1;
                        updateStepDisplay();
                    }
                };
            });

            // Update step content
            document.querySelectorAll('.step-content').forEach((content, index) => {
                content.classList.remove('active');
                if (index + 1 === currentStep) {
                    content.classList.add('active');
                }
            });
        }

        // Process files by sending to Flask backend
        async function processFiles() {
            const pdfPreviewContainer = document.getElementById('pdfPreviewContainer');
            const pdfPreviewIframe = document.getElementById('pdfPreviewIframe');
            const pdfPreviewMessage = document.getElementById('pdfPreviewMessage');
            // --- START OF MODIFICATION 1: Remove extractedText (no longer a textarea) ---
            // const extractedText = document.getElementById('extractedText'); // This element is removed
            const generatedPdfPreviewContainer = document.getElementById('generatedPdfPreviewContainer'); // NEW: Get the new generated PDF container
            const generatedPdfPreviewIframe = document.getElementById('generatedPdfPreviewIframe'); // NEW: Get the new generated PDF iframe
            const generatedPdfPreviewMessage = document.getElementById('generatedPdfPreviewMessage'); // NEW: Get the new message element for generated PDF
            // --- END OF MODIFICATION 1 ---

            const downloadBtn = document.getElementById('downloadBtn');
            const downloadMessage = document.getElementById('downloadMessage');
            const viewOriginalBtn = document.getElementById('viewOriginalPdfBtn');
            const viewGeneratedBtn = document.getElementById('viewGeneratedPdfBtn');

            // Reset preview area and buttons
            pdfPreviewIframe.style.display = 'none';
            pdfPreviewIframe.src = '';
            pdfPreviewMessage.textContent = 'Processing PDF...';
            pdfPreviewContainer.innerHTML = `
                <div class="pdf-view-toggle">
                    <button class="btn" id="viewOriginalPdfBtn" disabled>Original</button>
                    <button class="btn" id="viewGeneratedPdfBtn" disabled>Generated</button>
                </div>
                <div class="loading"><div class="spinner"></div></div>
                <p>${pdfPreviewMessage.textContent}</p>
            `;
            // Re-get button references after re-rendering innerHTML
            const newViewOriginalBtn = document.getElementById('viewOriginalPdfBtn');
            const newViewGeneratedBtn = document.getElementById('viewGeneratedPdfBtn');

            // --- START OF MODIFICATION 2: Reset generated PDF preview ---
            generatedPdfPreviewIframe.style.display = 'none';
            generatedPdfPreviewIframe.src = '';
            generatedPdfPreviewMessage.textContent = 'Processing and generating PDF...';
            generatedPdfPreviewContainer.innerHTML = `
                <div class="loading"><div class="spinner"></div></div>
                <p>${generatedPdfPreviewMessage.textContent}</p>
            `;
            // --- END OF MODIFICATION 2 ---


            // --- START OF MODIFICATION 3: Remove extractedText value setting ---
            // extractedText.value = 'Processing and extracting text...'; // This line is removed
            // --- END OF MODIFICATION 3 ---

            downloadBtn.disabled = true;
            downloadMessage.textContent = "Processing files, please wait...";
            newViewOriginalBtn.disabled = true;
            newViewGeneratedBtn.disabled = true;


            const formData = new FormData();
            // Append question paper
            if (questionPaper) {
                formData.append('question_paper', questionPaper);
            } else {
                // --- START OF MODIFICATION 4: Update error messages for generated PDF preview ---
                // extractedText.value = "Error: Question paper not uploaded."; // Removed
                generatedPdfPreviewMessage.textContent = "Error: Question paper not uploaded."; // Updated
                pdfPreviewMessage.textContent = "Error: Question paper not uploaded.";
                downloadMessage.textContent = "Processing failed: Question paper missing.";
                return; // Stop processing if question paper is missing
                // --- END OF MODIFICATION 4 ---
            }

            // Append selected student PDFs with their relative paths
            if (selectedFiles.length === 0) {
                 // --- START OF MODIFICATION 5: Update error messages for generated PDF preview ---
                 // extractedText.value = "Error: No student answer sheets selected for processing."; // Removed
                 generatedPdfPreviewMessage.textContent = "Error: No student answer sheets selected for processing."; // Updated
                 pdfPreviewMessage.textContent = "Error: No student answer sheets selected for processing.";
                 downloadMessage.textContent = "Processing failed: No student answer sheets.";
                 return; // Stop processing if no student PDFs are selected
                 // --- END OF MODIFICATION 5 ---
            }
            selectedFiles.forEach(file => {
                // Use webkitRelativePath for files from folder upload, otherwise use name
                const filePath = file.webkitRelativePath || file.name;
                formData.append('student_pdfs', file, filePath);
            });
            formData.append('model_selection', selectedModel);

            try {
                const response = await fetch('/', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP error! Status: ${response.status}`);
                }

                const data = await response.json();
                console.log("Backend response:", data);

                // --- START OF MODIFICATION 6: No longer update extractedText textarea ---
                // if (data.extracted_text) {
                //     extractedText.value = data.extracted_text;
                // } else {
                //     extractedText.value = "No extracted text available.";
                // }
                // --- END OF MODIFICATION 6 ---

                // --- START OF MODIFICATION 7: Update original PDF preview container content ---
                pdfPreviewContainer.innerHTML = `
                    <div class="pdf-view-toggle">
                        <button class="btn" id="viewOriginalPdfBtn">Original</button>
                        <button class="btn" id="viewGeneratedPdfBtn">Generated</button>
                    </div>
                    <iframe id="pdfPreviewIframe" type="application/pdf" style="display: block;"></iframe>
                    <p id="pdfPreviewMessage"></p>
                `;
                // Re-get iframe and button references after updating innerHTML
                const currentPdfIframe = document.getElementById('pdfPreviewIframe');
                const currentPdfMessage = document.getElementById('pdfPreviewMessage');
                const currentViewOriginalBtn = document.getElementById('viewOriginalPdfBtn');
                const currentViewGeneratedBtn = document.getElementById('viewGeneratedPdfBtn');
                // --- END OF MODIFICATION 7 ---


                // Store paths for view switching
                originalStudentPdfPath = data.original_student_pdf ? `/preview/${data.original_student_pdf}` : null;
                generatedPdfPath = data.pdf_filename ? `/preview/${data.pdf_filename}` : null; // Use /preview/ for display

                // --- START OF MODIFICATION 8: Populate generated PDF iframe ---
                generatedPdfPreviewContainer.innerHTML = `
                    <iframe id="generatedPdfPreviewIframe" type="application/pdf" style="display: block;"></iframe>
                    <p id="generatedPdfPreviewMessage"></p>
                `;
                const newGeneratedPdfIframe = document.getElementById('generatedPdfPreviewIframe');
                const newGeneratedPdfMessage = document.getElementById('generatedPdfPreviewMessage');

                if (generatedPdfPath) {
                    newGeneratedPdfIframe.src = generatedPdfPath; // Set src for generated PDF iframe
                    newGeneratedPdfIframe.style.display = 'block';
                    newGeneratedPdfMessage.style.display = 'none'; // Hide message if PDF is loading
                    downloadBtn.href = `/download/${data.pdf_filename}`; // Use /download/ for actual download
                    downloadBtn.disabled = false;
                    downloadMessage.textContent = "Your generated PDF is ready for preview and download.";
                    currentViewGeneratedBtn.disabled = false; // Enable generated view button on left
                } else {
                    newGeneratedPdfIframe.style.display = 'none';
                    newGeneratedPdfMessage.style.display = 'block';
                    newGeneratedPdfMessage.textContent = "Error: PDF generation failed.";
                    downloadBtn.disabled = true;
                    downloadMessage.textContent = "PDF generation failed.";
                    currentViewGeneratedBtn.disabled = true;
                }
                // --- END OF MODIFICATION 8 ---

                if (originalStudentPdfPath) {
                    // This block handles setting up the LEFT preview iframe
                    currentViewOriginalBtn.disabled = false;
                    // --- START OF MODIFICATION 9: Ensure correct active state and default view ---
                    // By default, show generated PDF in the left preview if available
                    if (generatedPdfPath) {
                        currentPdfView = 'generated';
                        currentPdfIframe.src = generatedPdfPath;
                        currentPdfMessage.style.display = 'none';
                        currentPdfIframe.style.display = 'block';
                        currentViewOriginalBtn.classList.remove('active');
                        currentViewGeneratedBtn.classList.add('active');
                    } else { // Fallback to original if generated PDF is not available
                        currentPdfView = 'original';
                        currentPdfIframe.src = originalStudentPdfPath;
                        currentPdfMessage.style.display = 'none';
                        currentPdfIframe.style.display = 'block';
                        currentViewOriginalBtn.classList.add('active');
                        currentViewGeneratedBtn.classList.remove('active');
                    }
                    // --- END OF MODIFICATION 9 ---

                    // Attach event listeners for the toggle buttons (MUST be re-attached as innerHTML was updated)
                    currentViewOriginalBtn.addEventListener('click', () => switchPdfView('original'));
                    currentViewGeneratedBtn.addEventListener('click', () => switchPdfView('generated'));

                } else {
                    currentViewOriginalBtn.disabled = true;
                    currentPdfIframe.style.display = 'none';
                    currentPdfMessage.style.display = 'block';
                    currentPdfMessage.textContent = "Original PDF not available.";
                }

                nextStep(); // Move to Step 3 (this will trigger updateStepDisplay())

            } catch (error) {
                console.error('Error during file processing:', error);
                // --- START OF MODIFICATION 10: Update error messages consistently ---
                pdfPreviewContainer.innerHTML = `
                    <div class="pdf-view-toggle">
                        <button class="btn" id="viewOriginalPdfBtn" disabled>Original</button>
                        <button class="btn" id="viewGeneratedPdfBtn" disabled>Generated</button>
                    </div>
                    <p class="error-message">Error: ${error.message}. Please try again.</p>
                `;
                generatedPdfPreviewContainer.innerHTML = `
                    <p class="error-message">Error: ${error.message}. Please try again.</p>
                `;
                // extractedText.value = `Error: ${error.message}.`; // Removed
                downloadBtn.disabled = true;
                downloadMessage.textContent = `Processing failed: ${error.message}.`;
                // --- END OF MODIFICATION 10 ---
            }
        }

        // --- START OF MODIFICATION 11: Add switchPdfView function ---
        function switchPdfView(viewType) {
            currentPdfView = viewType;
            const pdfPreviewIframe = document.getElementById('pdfPreviewIframe');
            const pdfPreviewMessage = document.getElementById('pdfPreviewMessage');
            const viewOriginalBtn = document.getElementById('viewOriginalPdfBtn');
            const viewGeneratedBtn = document.getElementById('viewGeneratedPdfBtn');

            // Reset active states
            viewOriginalBtn.classList.remove('active');
            viewGeneratedBtn.classList.remove('active');

            if (viewType === 'original') {
                if (originalStudentPdfPath) {
                    pdfPreviewIframe.src = originalStudentPdfPath;
                    pdfPreviewIframe.style.display = 'block';
                    pdfPreviewMessage.style.display = 'none';
                    viewOriginalBtn.classList.add('active');
                } else {
                    pdfPreviewIframe.style.display = 'none';
                    pdfPreviewMessage.style.display = 'block';
                    pdfPreviewMessage.textContent = 'Original PDF not available.';
                }
            } else if (viewType === 'generated') {
                if (generatedPdfPath) {
                    pdfPreviewIframe.src = generatedPdfPath;
                    pdfPreviewIframe.style.display = 'block';
                    pdfPreviewMessage.style.display = 'none';
                    viewGeneratedBtn.classList.add('active');
                } else {
                    pdfPreviewIframe.style.display = 'none';
                    pdfPreviewMessage.style.display = 'block';
                    pdfPreviewMessage.textContent = 'Generated PDF not available.';
                }
            }
        }
        // --- END OF MODIFICATION 11 ---


        // Download generated PDF
        function downloadPdf() {
            // The href for download button is already set in processFiles using /download/
            // So just click the link.
            const downloadLink = document.getElementById('downloadBtn');
            if (!downloadLink.disabled && downloadLink.href) {
                // Ensure it's a direct download, not opening in another preview
                const filename = downloadLink.href.split('/').pop(); // Extract filename from URL
                const directDownloadUrl = `/download/${filename}`; // Construct the direct download URL
                window.location.href = directDownloadUrl; // Triggers download
            } else {
                alert('No PDF available for download.');
            }
        }

        function startOver() {
            currentStep = 1;
            uploadedFiles = [];
            questionPaper = null;
            selectedFiles = [];
            selectedModel = '';
            originalStudentPdfPath = null;
            generatedPdfPath = null; // Reset generatedPdfPath

            document.getElementById('fileList').style.display = 'none';
            document.getElementById('folderInput').value = '';
            document.getElementById('questionInput').value = '';
            document.getElementById('fileSelection').innerHTML = '<option value="">Select files...</option><option value="all">Process all PDFs in folder</option>';
            document.getElementById('modelSelection').value = '';
            // --- START OF MODIFICATION 12: Reset generated PDF preview area in startOver ---
            // document.getElementById('extractedText').value = ''; // Removed
            const generatedPdfPreviewContainer = document.getElementById('generatedPdfPreviewContainer');
            generatedPdfPreviewContainer.innerHTML = `
                <iframe id="generatedPdfPreviewIframe" src="" type="application/pdf" style="display: none;"></iframe>
                <p id="generatedPdfPreviewMessage">Generated PDF will appear here.</p>
            `;
            // --- END OF MODIFICATION 12 ---

            // Reset PDF preview to initial state
            const pdfPreviewContainer = document.getElementById('pdfPreviewContainer');
            pdfPreviewContainer.innerHTML = `
                <div class="pdf-view-toggle">
                    <button class="btn active" id="viewOriginalPdfBtn" disabled>Original</button>
                    <button class="btn" id="viewGeneratedPdfBtn" disabled>Generated</button>
                </div>
                <iframe id="pdfPreviewIframe" src="" type="application/pdf" style="display: none;"></iframe>
                <p id="pdfPreviewMessage">Select files to process...</p>
            `;
            // Re-attach event listeners for newly created buttons in startOver
            document.getElementById('viewOriginalPdfBtn').addEventListener('click', () => switchPdfView('original'));
            document.getElementById('viewGeneratedPdfBtn').addEventListener('click', () => switchPdfView('generated'));


            document.getElementById('step1Next').disabled = true;
            document.getElementById('step2Next').disabled = true;
            document.getElementById('downloadBtn').disabled = true;
            document.getElementById('downloadMessage').textContent = "Your generated PDF will be ready for download after processing."; // Updated message

            updateStepDisplay();
        }

        // Initial setup
        document.addEventListener('DOMContentLoaded', () => {
            initDragDrop();
            updateStepDisplay(); // Set initial step to 1
            // Manually add event listeners for step buttons once the DOM is ready
            document.querySelectorAll('.step').forEach(stepDiv => {
                stepDiv.addEventListener('click', () => {
                    const targetStep = parseInt(stepDiv.dataset.step);
                    if (targetStep <= currentStep) { // Only allow navigating to previous or current step
                        currentStep = targetStep;
                        updateStepDisplay();
                    }
                });
            });

            // Attach initial event listeners for the original/generated PDF toggle buttons
            // These need to be attached once here, and then re-attached whenever pdfPreviewContainer.innerHTML is changed
            document.getElementById('viewOriginalPdfBtn').addEventListener('click', () => switchPdfView('original'));
            document.getElementById('viewGeneratedPdfBtn').addEventListener('click', () => switchPdfView('generated'));
        });
    </script>
</body>
</html>